SELECT
    EVENT_DATE,
    CONVERT_TIMEZONE('UTC', 'America/Los_Angeles', EVENT_TIMESTAMP) AS EVENT_TIMESTAMP_PST,
    EVENT_NAME,
    -- Flatten event_parameters, an unordered, variable size array of json objects
    MAX(CASE WHEN ep.value:key = 'page_location' THEN ep.value:value:string_value END) AS page_location,
    MAX(CASE WHEN ep.value:key = 'page_title' THEN ep.value:value:string_value END) AS page_title,
    MAX(CASE WHEN ep.value:key = 'page_referrer' THEN ep.value:value:string_value END) AS page_referrer,
    MAX(CASE WHEN ep.value:key = 'link_url' THEN ep.value:value:string_value END) AS link_url,
    MAX(CASE WHEN ep.value:key = 'link_domain' THEN ep.value:value:string_value END) AS link_domain,
    CASE
        -- Classifications below taken from Looker Studio report
        WHEN page_location IS NULL THEN NULL
        WHEN page_location LIKE '%csd.ca.gov%' THEN 'CSD'
        WHEN page_location LIKE '%broadband%' THEN 'ACP'
        WHEN page_location LIKE '%myfamily%' THEN 'WIC'
        WHEN page_location LIKE '%caleitc%' THEN 'CalEITC'
        WHEN page_location LIKE '%calfile%' THEN 'CalFile'
        ELSE 'Other'
    END AS page_location_alias,
    --EVENT_PREVIOUS_TIMESTAMP,
    --EVENT_VALUE_IN_USD,
    --EVENT_BUNDLE_SEQUENCE_ID,
    --EVENT_SERVER_TIMESTAMP_OFFSET,
    --USER_ID,
    USER_PSEUDO_ID,
    --PRIVACY_INFO_ANALYTICS_STORAGE,
    --PRIVACY_INFO_ADS_STORAGE,
    --PRIVACY_INFO_USES_TRANSIENT_TOKEN,
    --USER_PROPERTIES,
    --USER_FIRST_TOUCH_TIMESTAMP,
    --USER_LTV_REVENUE,
    --USER_LTV_CURRENCY,
    DEVICE_CATEGORY,
    --DEVICE_MOBILE_BRAND_NAME,
    --DEVICE_MOBILE_MODEL_NAME,
    --DEVICE_MOBILE_MARKETING_NAME,
    --DEVICE_MOBILE_OS_HARDWARE_MODEL,
    --DEVICE_OPERATING_SYSTEM,
    --DEVICE_OPERATING_SYSTEM_VERSION,
    --DEVICE_VENDOR_ID,
    --DEVICE_ADVERTISING_ID,
    DEVICE_LANGUAGE,
    --DEVICE_IS_LIMITED_AD_TRACKING,
    --DEVICE_TIME_ZONE_OFFSET_SECONDS,
    --DEVICE_BROWSER,
    --DEVICE_BROWSER_VERSION,
    --DEVICE_WEB_INFO_BROWSER,
    --DEVICE_WEB_INFO_BROWSER_VERSION,
    DEVICE_WEB_INFO_HOSTNAME,
    GEO_CONTINENT,
    GEO_COUNTRY,
    GEO_REGION,
    GEO_CITY,
    GEO_SUB_CONTINENT,
    GEO_METRO,
    --APP_INFO_ID,
    --APP_INFO_VERSION,
    --APP_INFO_INSTALL_STORE,
    --APP_INFO_FIREBASE_APP_ID,
    --APP_INFO_INSTALL_SOURCE,
    TRAFFIC_SOURCE_NAME,
    --TRAFFIC_SOURCE_MEDIUM,
    TRAFFIC_SOURCE_SOURCE,
    --STREAM_ID,
    --PLATFORM,
    --EVENT_DIMENSIONS_HOSTNAME,
    --ECOMMERCE_TOTAL_ITEM_QUANTITY,
    --ECOMMERCE_PURCHASE_REVENUE_IN_USD,
    --ECOMMERCE_PURCHASE_REVENUE,
    --ECOMMERCE_REFUND_VALUE_IN_USD,
    --ECOMMERCE_REFUND_VALUE,
    --ECOMMERCE_SHIPPING_VALUE_IN_USD,
    --ECOMMERCE_SHIPPING_VALUE,
    --ECOMMERCE_TAX_VALUE_IN_USD,
    --ECOMMERCE_TAX_VALUE,
    --ECOMMERCE_UNIQUE_ITEMS,
    --ECOMMERCE_TRANSACTION_ID,
    --ITEMS,
    --COLLECTED_TRAFFIC_SOURCE_MANUAL_CAMPAIGN_ID,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_CAMPAIGN_NAME,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_SOURCE,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_MEDIUM,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_TERM,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_CONTENT
    --COLLECTED_TRAFFIC_SOURCE_GCLID,
    --COLLECTED_TRAFFIC_SOURCE_DCLID,
    --COLLECTED_TRAFFIC_SOURCE_SRSLTID
FROM {{ ref('stg_ga_statewide') }},
    LATERAL FLATTEN(input => event_params) ep
GROUP BY all
