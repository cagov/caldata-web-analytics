{% set dt = (
    var('ga_statewide_beg_date')

) %}

{{ config(
    materialized='incremental',
    incremental_strategy='microbatch',
    event_time='EVENT_DATE',
    begin=dt,
    batch_size='day',
    snowflake_warehouse=get_snowflake_refresh_warehouse(big="XL", small="XS")
) }}

SELECT
    EVENT_DATE,
    EVENT_TIMESTAMP,
    EVENT_NAME,
    EVENT_PARAMS,
    -- EVENT_PREVIOUS_TIMESTAMP,
    -- EVENT_VALUE_IN_USD,
    -- EVENT_BUNDLE_SEQUENCE_ID,
    -- EVENT_SERVER_TIMESTAMP_OFFSET,
    -- USER_ID,
    USER_PSEUDO_ID,
    -- PRIVACY_INFO_ANALYTICS_STORAGE,
    -- PRIVACY_INFO_ADS_STORAGE,
    -- PRIVACY_INFO_USES_TRANSIENT_TOKEN,
    -- USER_PROPERTIES,
    -- USER_FIRST_TOUCH_TIMESTAMP,
    -- USER_LTV_REVENUE,
    -- USER_LTV_CURRENCY,
    DEVICE_CATEGORY,
    -- DEVICE_MOBILE_BRAND_NAME,
    -- DEVICE_MOBILE_MODEL_NAME,
    -- DEVICE_MOBILE_MARKETING_NAME,
    -- DEVICE_MOBILE_OS_HARDWARE_MODEL,
    -- DEVICE_OPERATING_SYSTEM,
    -- DEVICE_OPERATING_SYSTEM_VERSION,
    -- DEVICE_VENDOR_ID,
    -- DEVICE_ADVERTISING_ID,
    DEVICE_LANGUAGE,
    -- DEVICE_IS_LIMITED_AD_TRACKING,
    -- DEVICE_TIME_ZONE_OFFSET_SECONDS,
    -- DEVICE_BROWSER,
    -- DEVICE_BROWSER_VERSION,
    -- DEVICE_WEB_INFO_BROWSER,
    -- DEVICE_WEB_INFO_BROWSER_VERSION,
    DEVICE_WEB_INFO_HOSTNAME,
    GEO_CITY,
    GEO_COUNTRY,
    -- GEO_CONTINENT,
    GEO_REGION,
    -- GEO_SUB_CONTINENT,
    GEO_METRO,
    -- APP_INFO_ID,
    -- APP_INFO_VERSION,
    -- APP_INFO_INSTALL_STORE,
    -- APP_INFO_FIREBASE_APP_ID,
    -- APP_INFO_INSTALL_SOURCE,
    TRAFFIC_SOURCE_NAME,
    -- TRAFFIC_SOURCE_MEDIUM,
    TRAFFIC_SOURCE_SOURCE,
    -- STREAM_ID,
    -- PLATFORM,
    -- EVENT_DIMENSIONS_HOSTNAME,
    -- ECOMMERCE_TOTAL_ITEM_QUANTITY,
    -- ECOMMERCE_PURCHASE_REVENUE_IN_USD,
    -- ECOMMERCE_PURCHASE_REVENUE,
    -- ECOMMERCE_REFUND_VALUE_IN_USD,
    -- ECOMMERCE_REFUND_VALUE,
    -- ECOMMERCE_SHIPPING_VALUE_IN_USD,
    -- ECOMMERCE_SHIPPING_VALUE,
    -- ECOMMERCE_TAX_VALUE_IN_USD,
    -- ECOMMERCE_TAX_VALUE,
    -- ECOMMERCE_UNIQUE_ITEMS,
    -- ECOMMERCE_TRANSACTION_ID,
    -- ITEMS,
    -- ITEMS_ITEM_PARAMS,
    -- COLLECTED_TRAFIC_SOURCE_MANUAL_CAMPAIGN_ID,
    -- COLLECTED_TRAFIC_SOURCE_MANUAL_CAMPAIGN_NAME,
    -- COLLECTED_TRAFIC_SOURCE_MANUAL_SOURCE,
    -- COLLECTED_TRAFIC_SOURCE_MANUAL_MEDIUM,
    -- COLLECTED_TRAFIC_SOURCE_MANUAL_TERM,
    -- COLLECTED_TRAFIC_SOURCE_MANUAL_CONTENT,
    -- COLLECTED_TRAFIC_SOURCE_GCLID,
    -- COLLECTED_TRAFIC_SOURCE_DCLID,
    -- COLLECTED_TRAFIC_SOURCE_SRSLTID,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_CAMPAIGN_ID,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_CAMPAIGN_NAME,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_SOURCE,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_MEDIUM,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_TERM,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_CONTENT,
    -- COLLECTED_TRAFFIC_SOURCE_GCLID,
    -- COLLECTED_TRAFFIC_SOURCE_DCLID,
    -- COLLECTED_TRAFFIC_SOURCE_SRSLTID,
    -- IS_ACTIVE_USER,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_SOURCE_PLATFORM,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_CREATIVE_FORMAT,
    COLLECTED_TRAFFIC_SOURCE_MANUAL_MARKETING_TACTIC,
    BATCH_EVENT_INDEX,
    BATCH_PAGE_ID,
    BATCH_ORDERING_ID,
    SESSION_TRAFFIC_SOURCE_LAST_CLICK_MANUAL_CAMPAIGN_CAMPAIGN_ID,
    SESSION_TRAFFIC_SOURCE_LAST_CLICK_MANUAL_CAMPAIGN_CAMPAIGN_NAME,
    SESSION_TRAFFIC_SOURCE_LAST_CLICK_MANUAL_CAMPAIGN_SOURCE,
    SESSION_TRAFFIC_SOURCE_LAST_CLICK_MANUAL_CAMPAIGN_MEDIUM,
    SESSION_TRAFFIC_SOURCE_LAST_CLICK_MANUAL_CAMPAIGN_TERM,
    SESSION_TRAFFIC_SOURCE_LAST_CLICK_MANUAL_CAMPAIGN_CONTENT,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_MANUAL_CAMPAIGN_SOURCE_PLATFORM,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_MANUAL_CAMPAIGN_CREATIVE_FORMAT,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_MANUAL_CAMPAIGN_MARKETING_TACTIC,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_GOOGLE_ADS_CAMPAIGN_CUSTOMER_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_GOOGLE_ADS_CAMPAIGN_ACCOUNT_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_GOOGLE_ADS_CAMPAIGN_CAMPAIGN_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_GOOGLE_ADS_CAMPAIGN_CAMPAIGN_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_GOOGLE_ADS_CAMPAIGN_AD_GROUP_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_GOOGLE_ADS_CAMPAIGN_AD_GROUP_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CROSS_CHANNEL_CAMPAIGN_CAMPAIGN_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CROSS_CHANNEL_CAMPAIGN_CAMPAIGN_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CROSS_CHANNEL_CAMPAIGN_SOURCE,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CROSS_CHANNEL_CAMPAIGN_MEDIUM,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CROSS_CHANNEL_CAMPAIGN_SOURCE_PLATFORM,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CROSS_CHANNEL_CAMPAIGN_DEFAULT_CHANNEL_GROUP,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CROSS_CHANNEL_CAMPAIGN_PRIMARY_CHANNEL_GROUP,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_SA360_CAMPAIGN_CAMPAIGN_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_SA360_CAMPAIGN_CAMPAIGN_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_SA360_CAMPAIGN_SOURCE,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_SA360_CAMPAIGN_MEDIUM,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_SA360_CAMPAIGN_AD_GROUP_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_SA360_CAMPAIGN_AD_GROUP_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_SA360_CAMPAIGN_CREATIVE_FORMAT,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_SA360_CAMPAIGN_ENGINE_ACCOUNT_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_SA360_CAMPAIGN_ENGINE_ACCOUNT_TYPE,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_SA360_CAMPAIGN_MANAGER_ACCOUNT_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_CAMPAIGN_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_CAMPAIGN_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_SOURCE,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_MEDIUM,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_ACCOUNT_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_ACCOUNT_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_ADVERTISER_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_ADVERTISER_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_CREATIVE_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_CREATIVE_FORMAT,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_CREATIVE_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_CREATIVE_TYPE,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_CREATIVE_TYPE_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_CREATIVE_VERSION,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_PLACEMENT_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_PLACEMENT_COST_STRUCTURE,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_PLACEMENT_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_RENDERING_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_SITE_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_CM360_CAMPAIGN_SITE_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_CAMPAIGN_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_CAMPAIGN_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_SOURCE,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_MEDIUM,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_ADVERTISER_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_ADVERTISER_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_CREATIVE_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_CREATIVE_FORMAT,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_CREATIVE_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_EXCHANGE_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_EXCHANGE_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_INSERTION_ORDER_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_INSERTION_ORDER_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_LINE_ITEM_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_LINE_ITEM_NAME,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_PARTNER_ID,
    -- SESSION_TRAFFIC_SOURCE_LAST_CLICK_DV360_CAMPAIGN_PARTNER_NAME,
    -- PUBLISHER_AD_REVENUE_IN_USD,
    -- PUBLISHER_AD_FORMAT,
    -- PUBLISHER_AD_SOURCE_NAME,
    -- PUBLISHER_AD_UNIT_ID,
    EVENT_PARAMS__FLATTENED,
    -- using trim() to remove double quotes at start and end
    trim(EVENT_PARAMS__FLATTENED:page_location, '"') AS PAGE_LOCATION,
    EVENT_PARAMS__FLATTENED:page_title AS PAGE_TITLE,
    EVENT_PARAMS__FLATTENED:page_referrer AS PAGE_REFERRER,
    EVENT_PARAMS__FLATTENED:link_url AS LINK_URL,
    EVENT_PARAMS__FLATTENED:link_domain AS LINK_DOMAIN
    -- USER_PROPERTIES__FLATTENED,

FROM {{ source('CA_GOOGLE_ANALYTICS', 'ANALYTICS_314711183__VIEW') }}
